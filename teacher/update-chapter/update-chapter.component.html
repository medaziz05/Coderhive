<main>
    <section class="bd-new-course-area section-space">
        <div class="container">
            <h2 class="text-center mb-4">Update Chapter</h2>
            <div class="row g-30 justify-content-center">
                <div class="col-xl-8 col-lg-9">
                    <div class="bd-new-course-wrapper">
                        <div class="card p-4" > 
                            <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                                {{ errorMessage }}
                                <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
                            </div>

                            <!-- Loading Overlay -->
                            <div *ngIf="isLoading" class="loading-overlay">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading chapter details...</p>
                            </div>

                            <form #chapterForm="ngForm" (ngSubmit)="onSubmit(chapterForm)" novalidate *ngIf="!isLoading">
                                <!-- Form-wide Error -->
                                <div *ngIf="formSubmitted && chapterForm.invalid" class="alert alert-warning">
                                    Please correct the errors in the form before submitting.
                                </div>

                                <!-- Chapter Title -->
                                <div class="form-input-box mb-20">
                                    <div class="form-input-title">
                                        <label for="chapterTitle">Chapter Title</label>
                                    </div>
                                    <div class="form-input">
                                        <input [(ngModel)]="chapterRequest.chapterTitle" name="chapterTitle"
                                            id="chapterTitle" type="text" placeholder="Enter Chapter Title" required
                                            minlength="3" #titleRef="ngModel"
                                            [class.is-invalid]="titleRef.invalid && (titleRef.touched || formSubmitted)">
                                        <div *ngIf="titleRef.invalid && (titleRef.touched || formSubmitted)"
                                            class="invalid-feedback">
                                            <div *ngIf="titleRef.errors?.['required']">Title is required</div>
                                            <div *ngIf="titleRef.errors?.['minlength']">Minimum 3 characters required</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chapter Description -->
                                <div class="form-input-box mb-20">
                                    <div class="form-input-title">
                                        <label for="chapterDescription">Description</label>
                                    </div>
                                    <div class="form-input">
                                        <textarea [(ngModel)]="chapterRequest.chapterDescription"
                                            name="chapterDescription" id="chapterDescription"
                                            placeholder="Enter Chapter Description" required minlength="10" #descRef="ngModel"
                                            [class.is-invalid]="descRef.invalid && (descRef.touched || formSubmitted)"></textarea>
                                        <div *ngIf="descRef.invalid && (descRef.touched || formSubmitted)"
                                            class="invalid-feedback">
                                            <div *ngIf="descRef.errors?.['required']">Description is required</div>
                                            <div *ngIf="descRef.errors?.['minlength']">Minimum 10 characters required</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chapter Order -->
<div class="form-input-box mb-20">
    <div class="form-input-title">
        <label for="chapterOrder">Chapter Order</label>
    </div>
    <div class="form-input">
        <input [(ngModel)]="chapterRequest.chapterOrder" 
               name="chapterOrder"
               id="chapterOrder" 
               type="number" 
               min="1" 
               step="1"
               pattern="^[1-9]\d*$"
               required 
               #orderRef="ngModel"
               (keypress)="validateNumberInput($event)"
               (paste)="validatePaste($event)"
               [class.is-invalid]="orderRef.invalid && (orderRef.touched || formSubmitted)">
        
        <div *ngIf="orderRef.invalid && (orderRef.touched || formSubmitted)" class="invalid-feedback">
            <div *ngIf="orderRef.errors?.['required']">Order is required</div>
            <div *ngIf="orderRef.errors?.['min'] || orderRef.errors?.['pattern']">
                chapter's order start from 1 do you not know math 
            </div>
        </div>
    </div>
</div>

                                <!-- Existing Attachments -->
<!-- Existing Attachments -->
<div class="form-input-box mb-20" *ngIf="existingAttachments.length > 0">
    <div class="form-input-title">
        <label>Existing Attachments</label>
    </div>
    <div class="existing-attachments">
        <div *ngFor="let attachment of existingAttachments" class="attachment-item mb-3">
            <div class="d-flex align-items-center justify-content-between">
                <div class="file-info flex-grow-1 me-3">
                    <i class="fas fa-paperclip me-2"></i>
                    <span class="file-name text-truncate">{{ attachment.fileName }}</span>
                    <small class="text-muted ms-2">({{ attachment.fileType }})</small>
                </div>
                <div class="d-flex gap-2">
                    <a [href]="attachment.previewUrl" target="_blank"
                        class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye"></i> Preview
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
                                <!-- New Attachments -->
                                <div class="form-input-box mb-20">
                                    <div class="form-input-title">
                                        <label for="chapterFiles" class="upload-label">Add New Attachments</label>
                                    </div>
                                    <div class="form-input">
                                        <div class="custom-file-upload">
                                            <input type="file" id="chapterFiles" name="attachments"
                                                (change)="onFileSelected($event)" multiple accept=".pdf,.doc,.docx,.txt"
                                                class="file-input">
                                            <label for="chapterFiles" class="file-label">
                                                <i class="fas fa-upload"></i> Choose Files
                                            </label>
                                        </div>
                                        <small id="fileHelp" class="form-text text-muted">
                                            Max 10MB per file. Allowed formats: PDF, DOC, DOCX, TXT
                                        </small>

                                        <!-- New File Previews -->
                                        <div *ngIf="selectedFiles.length > 0" class="file-preview mt-2">
                                            <div *ngFor="let file of selectedFiles" class="file-item new-file">
                                                <span class="file-name">{{ file.name }}</span>
                                                <span class="file-size">({{ formatFileSize(file.size) }})</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-flex-items justify-content-start gap-30 mt-30">
                                    <button type="submit" class="bd-btn btn-primary" [disabled]="chapterForm.invalid || loading">
                                        <span *ngIf="!loading">Update Chapter</span>
                                        <span *ngIf="loading">Updating...</span>
                                    </button>
                                    <a [routerLink]="['/teacher/courses', courseId, 'chapters', chapterId]"
                                        class="bd-btn btn-outline-secondary">
                                        Cancel
                                    </a>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
